<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>API Key</title>
  <link rel="stylesheet" href="https://homey-cdn.athom.com/homey-css/1.0.0/homey.min.css">
  <style>
    .form-group {
      margin-bottom: 16px;
    }
    .form-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
    }
    .form-input {
      width: 100%;
      padding: 12px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 16px;
      box-sizing: border-box;
      font-family: monospace;
    }
    .form-hint {
      margin-top: 4px;
      font-size: 12px;
      color: #666;
    }
    .instructions {
      background: #f5f5f5;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 16px;
    }
    .instructions h3 {
      margin-top: 0;
      margin-bottom: 12px;
      font-size: 14px;
    }
    .instructions ol {
      margin: 0;
      padding-left: 20px;
    }
    .instructions li {
      margin-bottom: 8px;
      font-size: 13px;
      line-height: 1.4;
    }
    .password-toggle {
      position: relative;
    }
    .password-toggle input {
      padding-right: 48px;
    }
    .toggle-visibility {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      cursor: pointer;
      color: #666;
      font-size: 14px;
    }
    .error-message {
      color: #ff3b30;
      font-size: 14px;
      margin-top: 8px;
      display: none;
    }
    .error-message.visible {
      display: block;
    }
  </style>
</head>
<body>
  <div class="homey-content">
    <h1 data-i18n="pair.api_key.title">API Key</h1>
    <p data-i18n="pair.api_key.description">Enter your Unraid Connect API key to authenticate with your server.</p>
    
    <div class="instructions">
      <h3 data-i18n="pair.api_key.instructions_title">How to get your API key:</h3>
      <ol>
        <li data-i18n="pair.api_key.step1">Open your Unraid web UI</li>
        <li data-i18n="pair.api_key.step2">Go to Settings â†’ Management Access</li>
        <li data-i18n="pair.api_key.step3">Scroll down to "API Keys"</li>
        <li data-i18n="pair.api_key.step4">Click "Create API Key" and give it a name (e.g., "Homey")</li>
        <li data-i18n="pair.api_key.step5">Copy the generated key and paste it below</li>
      </ol>
    </div>

    <div class="form-group">
      <label class="form-label" for="apiKey" data-i18n="pair.api_key.label">API Key</label>
      <div class="password-toggle">
        <input type="password" id="apiKey" class="form-input" placeholder="Enter your API key" autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false">
        <button type="button" class="toggle-visibility" onclick="toggleVisibility()">Show</button>
      </div>
      <p class="form-hint" data-i18n="pair.api_key.hint">Your API key is stored securely and only used to communicate with your Unraid server</p>
      <p id="apikey-error" class="error-message"></p>
    </div>
  </div>

  <script src="https://homey-cdn.athom.com/homey-js/1.0.0/homey.min.js"></script>
  <script>
    let isVisible = false;

    function toggleVisibility() {
      const input = document.getElementById('apiKey');
      const button = document.querySelector('.toggle-visibility');
      
      isVisible = !isVisible;
      input.type = isVisible ? 'text' : 'password';
      button.textContent = isVisible ? 'Hide' : 'Show';
    }

    function showError(message) {
      const errorEl = document.getElementById('apikey-error');
      errorEl.textContent = message;
      errorEl.classList.add('visible');
    }

    function hideError() {
      const errorEl = document.getElementById('apikey-error');
      errorEl.classList.remove('visible');
    }

    function validateApiKey(apiKey) {
      if (!apiKey || apiKey.trim() === '') {
        return { valid: false, error: 'Please enter your API key' };
      }
      
      const trimmed = apiKey.trim();
      
      // API keys are typically at least 20 characters
      if (trimmed.length < 20) {
        return { valid: false, error: 'API key appears to be too short. Please check and try again.' };
      }
      
      return { valid: true };
    }

    Homey.setTitle(__('pair.api_key.title') || 'API Key');

    // Load saved API key if returning to this step
    Homey.emit('getApiKey', null, (err, apiKey) => {
      if (apiKey) {
        document.getElementById('apiKey').value = apiKey;
      }
    });

    Homey.on('showView', () => {
      hideError();
      document.getElementById('apiKey').focus();
    });

    // Validate and emit data when navigating to next step
    Homey.on('next', () => {
      const apiKey = document.getElementById('apiKey').value;

      const validation = validateApiKey(apiKey);
      if (!validation.valid) {
        showError(validation.error);
        return false;
      }

      hideError();
      
      Homey.emit('setApiKey', apiKey.trim(), (err) => {
        if (err) {
          showError(err.message || 'Failed to save API key');
          return;
        }
        Homey.nextView();
      });
      
      return false; // Prevent default navigation, we handle it in the callback
    });
  </script>
</body>
</html>
