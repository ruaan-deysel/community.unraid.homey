<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Connect to Unraid Server</title>
  <link rel="stylesheet" href="https://homey-cdn.athom.com/homey-css/1.0.0/homey.min.css">
  <style>
    .form-group {
      margin-bottom: 16px;
    }
    .form-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
    }
    .form-input {
      width: 100%;
      padding: 12px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 16px;
      box-sizing: border-box;
    }
    .form-hint {
      margin-top: 4px;
      font-size: 12px;
      color: #666;
    }
    .error-message {
      color: #ff3b30;
      font-size: 14px;
      margin-top: 8px;
      display: none;
    }
    .error-message.visible {
      display: block;
    }
  </style>
</head>
<body>
  <div class="homey-content">
    <h1 data-i18n="pair.host.title">Server Address</h1>
    <p data-i18n="pair.host.description">Enter the IP address or hostname of your Unraid server.</p>
    
    <div class="form-group">
      <label class="form-label" for="host" data-i18n="pair.host.label">Server Address</label>
      <input type="text" id="host" class="form-input" placeholder="192.168.1.100 or tower.local" autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false">
      <p class="form-hint" data-i18n="pair.host.hint">This is the same address you use to access the Unraid web UI</p>
      <p id="host-error" class="error-message"></p>
    </div>
  </div>

  <script src="https://homey-cdn.athom.com/homey-js/1.0.0/homey.min.js"></script>
  <script>
    function showError(message) {
      const errorEl = document.getElementById('host-error');
      errorEl.textContent = message;
      errorEl.classList.add('visible');
    }

    function hideError() {
      const errorEl = document.getElementById('host-error');
      errorEl.classList.remove('visible');
    }

    function validateHost(host) {
      if (!host || host.trim() === '') {
        return { valid: false, error: 'Please enter a server address' };
      }
      
      const trimmed = host.trim();
      
      // Basic IP address validation
      const ipRegex = /^(\d{1,3}\.){3}\d{1,3}$/;
      if (ipRegex.test(trimmed)) {
        const parts = trimmed.split('.').map(Number);
        if (parts.every(p => p >= 0 && p <= 255)) {
          return { valid: true };
        }
        return { valid: false, error: 'Invalid IP address' };
      }
      
      // Basic hostname validation
      const hostnameRegex = /^[a-zA-Z0-9]([a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(\.[a-zA-Z0-9]([a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/;
      if (hostnameRegex.test(trimmed)) {
        return { valid: true };
      }
      
      return { valid: false, error: 'Please enter a valid IP address or hostname' };
    }

    Homey.setTitle(__('pair.host.title') || 'Server Address');

    // Load saved values if returning to this step
    Homey.getViewStoreValue('host', 'host').then((host) => {
      if (host) {
        document.getElementById('host').value = host;
      }
    }).catch(() => {});

    Homey.on('showView', () => {
      hideError();
      document.getElementById('host').focus();
    });

    // Validate and save data when navigating to next step
    Homey.on('next', () => {
      const host = document.getElementById('host').value;

      const validation = validateHost(host);
      if (!validation.valid) {
        showError(validation.error);
        return false;
      }

      hideError();
      
      // Emit to backend using Promise-based API and wait before navigating
      Homey.emit('setHostData', { host: host.trim() })
        .then(() => {
          Homey.nextView();
        })
        .catch((err) => {
          showError(err.message || 'Failed to save host');
        });
      
      // Prevent default navigation - we'll navigate manually after emit completes
      return false;
    });
  </script>
</body>
</html>
